LIST P='16F877A' 
INCLUDE "P16F877A.INC" ; INCLUDE PIC P16F877A DEFAULT LIB
;-----------MOTOR VARIABLES-------------;
ACTIVE EQU H'20' ;	MOTOR START VARIABLE
PASSIVE EQU H'21' ;	MOTOR STOP VARIABLE
ACTIVECOUNTER EQU H'22' ; ACTIVE TIME COUNTER
PASSIVECOUNTER EQU H'23' ; PASSIVE TIME COUNTER
PWMCOUNTER EQU H'24' ; START-STOP COUNTER
;-----------DELAY VARIABLES-------------;
COUNTER1 EQU H'25' ; COUNTER1 VARIABLE
COUNTER2 EQU H'26' ; COUNTER2 VARIABLE
COUNTER3 EQU H'27' ; COUNTER3 VARIABLE
;-----------------CONFIG----------------;
BSF STATUS,5 ; GO TO BANK1
MOVLW H'FF'	;1111 1111
MOVWF TRISB ; SET PORTA AS INPUT
CLRF TRISD ; SET PORTD AS OUTPUT
BCF STATUS,5
CLRF PORTD ;INITIALIZE PORTD TO 0
;-----------------START----------------;
GOTO STOP ; CHECK RUN BUTTON
RUN
MOVLW H'05' ; NORMAL SPEED IS %50
MOVWF ACTIVECOUNTER
MOVWF PASSIVECOUNTER
RUNLOOP
;-------------STOP BUTTON CHECK------------;
BTFSC PORTB, 3 ;CHECK STOP BUTTON
GOTO STOP ; GO TO STOP 
;-----------SLOWDOWN BUTTON CHECK----------;
BTFSC PORTB, 7 ;CHECK SLOW DOWN BUTTON
GOTO SLOWDOWN ; GO TO SLOWDOWN
;-----------ACCELERATE BUTTON CHECK----------;
BTFSC PORTB, 5 ;CHECK ACCELERATE BUTTON
GOTO ACCELERATE ; GO TO ACCELERATE
GOTO PWM ; GO AND RUN MOTOR


;-----------STOP BUTTON CHECK----------;
STOP		; STOP LOOP
BTFSC PORTB,1 ; CHECK RUN BUTTON
GOTO RUN 	  ; GOTO RUN
GOTO STOP	  ; ENDLESS CHECK

;-----------ACCELERATE BUTTON CHECK----------;
ACCELERATE	
MOVLW H'00' 
SUBWF PASSIVECOUNTER, W ;IF STATUS 2 IS 1 WE BLOCK TO PASS THE LIMIT
BTFSS STATUS, 2 
GOTO ACCELERATE_CONTINUE 
BCF STATUS, 2 ; CLEAR STATUS 2
DECF ACTIVECOUNTER, F ; DECREASE 1
INCF PASSIVECOUNTER, F ; INCREASE 1
ACCELERATE_CONTINUE 
INCF ACTIVECOUNTER, F ; INCREASE 1
DECF PASSIVECOUNTER, F ; DECREASE 1
CALL DELAY			; CALL DELAY
GOTO PWM			; GOTO PWM

;-----------SLOW DOWN BUTTON CHECK----------;
SLOWDOWN
MOVLW H'00'
SUBWF ACTIVECOUNTER, W ;IF STATUS 2 IS 0 WE BLOCK TO PASS THE LIMIT
BTFSS STATUS,2	; CHECK STATUS 2
GOTO SLOWDOWN_CONTINUE ;KEEP AT THE SLOWEST LIMIT
BCF STATUS, 2	; CLEAR STATUS 2
INCF ACTIVECOUNTER, F ; INCREASE 1
DECF PASSIVECOUNTER, F ; DECREASE 1
SLOWDOWN_CONTINUE
DECF ACTIVECOUNTER,F ; DECREASE 1
INCF PASSIVECOUNTER,F  ; INCREASE 1
CALL DELAY			; CALL DELAY
GOTO PWM			; GOTO PWM

;------------------PWM-----------------;
PWM 
BSF PORTD, 1 
MOVFW ACTIVECOUNTER
CALL TABLE 
MOVWF ACTIVE
CALL PWM_DELAY
BCF PORTD, 1 
MOVFW PASSIVECOUNTER
CALL TABLE
MOVWF PASSIVE
CALL PWM_DELAY 
GOTO RUNLOOP
;---------------PWM DELAY---------------;
PWM_DELAY 
MOVWF PWMCOUNTER ; MOVE W TO PWMCOUNTER
LOOPPMWDELAY
DECFSZ PWMCOUNTER, F ; DECREASE PWMCOUNTER BY 1
GOTO LOOPPMWDELAY	; GO TO LOOPPMWDELAY AND DECREASE UNTIL IT IS H'00
RETURN 

;--------------SPEED TABLE-------------;
TABLE ; 
ADDWF PCL,F 
RETLW H'01' 
RETLW H'1A' 
RETLW H'33' 
RETLW H'4D' 
RETLW H'66' 
RETLW H'80' ; NORMAL SPEED
RETLW H'9A' 
RETLW H'B3' 
RETLW H'CD' 
RETLW H'E6' 
RETLW H'FE' 
;-----------------DELAY----------------;
;DELAY SUBPROGRAM
DELAY				; Delay subprogram
MOVLW h'FF'			; h’FF’ >> COUNTER1	
MOVWF COUNTER1		
LOOP1
MOVLW h'FF'
MOVWF COUNTER2		; h’FF’ >> COUNTER2
LOOP2
MOVLW h'03'
MOVWF COUNTER3		; h’03’ >> COUNTER3
LOOP3
DECFSZ COUNTER3,F	; If (CNT3 - 1) == 0 jump
GOTO LOOP3
DECFSZ COUNTER2,F	; If (CNT2 - 1) == 0 jump
GOTO LOOP2
DECFSZ COUNTER1,F	; If (CNT1 - 1) == 0 jump
RETURN				; Return under the line where it was called before

END
